{% extends "base.html" %}

{% block title %}{{ title }} - {{ app_name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('search.index') }}">Search</a></li>
{% if device_name %}
<li class="breadcrumb-item"><a href="{{ url_for('devices.device_detail', device_name=device_name) }}">{{ device_name }}</a></li>
{% endif %}
<li class="breadcrumb-item active">{{ title }}</li>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0">
                            <i class="bi {{ icon_class or 'bi-table' }} me-2"></i>
                            {{ title }}
                        </h4>
                        {% if subtitle %}
                        <small class="text-muted">{{ subtitle }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            {% if back_url %}
                            <a href="{{ back_url }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back
                            </a>
                            {% endif %}
                            <button class="btn btn-outline-success" onclick="exportData()">
                                <i class="bi bi-download me-1"></i>Export
                            </button>
                            <button class="btn btn-outline-primary" onclick="refreshData()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% if metadata %}
            <div class="card-body">
                <div class="row">
                    {% for key, value in metadata.items() %}
                    <div class="col-md-3">
                        <strong>{{ key|title }}:</strong>
                        {% if value is mapping %}
                            {% for k, v in value.items() %}
                                <span class="badge bg-secondary me-1">{{ k }}: {{ v }}</span>
                            {% endfor %}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Statistics Row -->
{% if stats %}
<div class="row mb-4">
    {% for stat in stats %}
    <div class="col-lg-{{ 12 // stats|length }} col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value text-{{ stat.color or 'primary' }}">{{ stat.value }}</div>
                <div class="metric-label">{{ stat.label }}</div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Filters -->
{% if filters %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    {% for filter in filters %}
                    <div class="col-md-{{ filter.col_size or 3 }}">
                        <label for="{{ filter.id }}" class="form-label">{{ filter.label }}</label>
                        {% if filter.type == 'select' %}
                        <select class="form-select" id="{{ filter.id }}" name="{{ filter.name }}">
                            <option value="">{{ filter.placeholder or 'All' }}</option>
                            {% for option in filter.options %}
                            <option value="{{ option.value }}">{{ option.label }}</option>
                            {% endfor %}
                        </select>
                        {% elif filter.type == 'search' %}
                        <input type="text" class="form-control" id="{{ filter.id }}" name="{{ filter.name }}"
                               placeholder="{{ filter.placeholder or 'Search...' }}">
                        {% elif filter.type == 'date' %}
                        <input type="date" class="form-control" id="{{ filter.id }}" name="{{ filter.name }}">
                        {% endif %}
                    </div>
                    {% endfor %}
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Data Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ table_title or title }} Data</h5>
                <div class="d-flex align-items-center">
                    {% if show_pagination %}
                    <span class="text-muted me-3">
                        Showing <span id="visibleCount">{{ data|length }}</span> of {{ total_count or data|length }} records
                    </span>
                    {% endif %}
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="liveFilter" checked>
                        <label class="form-check-label" for="liveFilter">Live Filter</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if data %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover" id="dataTable">
                        <thead>
                            <tr>
                                {% for column in columns %}
                                <th class="{{ column.class or '' }}" data-sort="{{ column.sort or column.key }}">
                                    {{ column.label }}
                                    {% if column.sortable %}
                                    <i class="bi bi-arrow-down-up text-muted ms-1"></i>
                                    {% endif %}
                                </th>
                                {% endfor %}
                                {% if show_actions %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr {% if row_attributes %}{% for attr, value in row_attributes.items() %}data-{{ attr }}="{{ row[value] }}"{% endfor %}{% endif %}>
                                {% for column in columns %}
                                <td>
                                    {% set value = row[column.key] %}
                                    {% if column.type == 'badge' %}
                                        <span class="badge {{ column.badge_class or 'bg-secondary' }}">{{ value }}</span>
                                    {% elif column.type == 'status' %}
                                        {% if value == 'up' or value == 'enabled' or value == 'online' %}
                                            <span class="status-badge status-online">
                                                <i class="bi bi-check-circle me-1"></i>{{ value|title }}
                                            </span>
                                        {% elif value == 'down' or value == 'disabled' or value == 'offline' %}
                                            <span class="status-badge status-offline">
                                                <i class="bi bi-x-circle me-1"></i>{{ value|title }}
                                            </span>
                                        {% else %}
                                            <span class="status-badge status-warning">
                                                <i class="bi bi-question-circle me-1"></i>{{ value|title }}
                                            </span>
                                        {% endif %}
                                    {% elif column.type == 'code' %}
                                        <code>{{ value }}</code>
                                    {% elif column.type == 'link' %}
                                        <a href="{{ column.url_template.format(**row) }}" class="text-decoration-none">{{ value }}</a>
                                    {% elif column.type == 'device_link' %}
                                        <a href="{{ url_for('devices.device_detail', device_name=value) }}" class="text-decoration-none">
                                            <strong>{{ value }}</strong>
                                        </a>
                                    {% elif column.type == 'config_link' %}
                                        <a href="{{ url_for('search.view_config', config_id=row['config_id']) }}" class="text-decoration-none">
                                            {{ value }}
                                        </a>
                                    {% elif column.type == 'datetime' %}
                                        {% if value %}
                                        <div>{{ value|datetime }}</div>
                                        <small class="text-muted">{{ value|relative_time }}</small>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    {% elif column.type == 'file_size' %}
                                        {{ value|file_size if value else 'N/A' }}
                                    {% elif column.type == 'ip_list' %}
                                        {% if value %}
                                            {% for ip in value.split(',') %}
                                                <code class="d-block">{{ ip.strip() }}</code>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No IPs</span>
                                        {% endif %}
                                    {% elif column.type == 'truncate' %}
                                        {% if value and value|length > (column.max_length or 30) %}
                                        <span title="{{ value }}">{{ value[:(column.max_length or 30)] }}...</span>
                                        {% else %}
                                        {{ value or 'N/A' }}
                                        {% endif %}
                                    {% elif column.type == 'metric' %}
                                        {% if value is not none %}
                                            {{ value }}{{ column.unit or '' }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    {% else %}
                                        {{ value if value is not none else 'N/A' }}
                                    {% endif %}
                                </td>
                                {% endfor %}
                                {% if show_actions %}
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% for action in actions %}
                                        {% if action.condition is not defined or row[action.condition] %}
                                        <a href="{{ action.url_template.format(**row) }}"
                                           class="btn btn-outline-{{ action.color or 'primary' }}"
                                           title="{{ action.tooltip or action.label }}">
                                            <i class="bi {{ action.icon }}"></i>
                                        </a>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi {{ empty_icon or 'bi-inbox' }} fs-1"></i>
                    <h4 class="mt-3">{{ empty_title or 'No Data Found' }}</h4>
                    <p>{{ empty_message or 'No records match your current criteria.' }}</p>
                    {% if empty_action %}
                    <a href="{{ empty_action.url }}" class="btn btn-primary">
                        <i class="bi {{ empty_action.icon }} me-1"></i>
                        {{ empty_action.label }}
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for table management
let originalData = {{ data|tojson if data else '[]' }};
let filteredData = [...originalData];

document.addEventListener('DOMContentLoaded', function() {
    initializeTable();
    setupFilters();
});

function initializeTable() {
    const table = document.getElementById('dataTable');
    if (!table) return;

    // Add sorting functionality
    const headers = table.querySelectorAll('th[data-sort]');
    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            sortTable(sortKey);
        });
    });
}

function setupFilters() {
    const liveFilter = document.getElementById('liveFilter');
    const filterInputs = document.querySelectorAll('#filterForm input, #filterForm select');

    filterInputs.forEach(input => {
        input.addEventListener('input', () => {
            if (liveFilter && liveFilter.checked) {
                applyFilters();
            }
        });
    });

    // Apply filters on form submission
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            applyFilters();
        });
    }
}

function applyFilters() {
    const filterForm = document.getElementById('filterForm');
    if (!filterForm) return;

    const formData = new FormData(filterForm);
    const filters = {};

    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            filters[key] = value.trim().toLowerCase();
        }
    }

    filteredData = originalData.filter(row => {
        return Object.entries(filters).every(([key, value]) => {
            const rowValue = String(row[key] || '').toLowerCase();
            return rowValue.includes(value);
        });
    });

    updateTable();
    updateVisibleCount();
}

function updateTable() {
    const tbody = document.querySelector('#dataTable tbody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        if (index < filteredData.length) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function updateVisibleCount() {
    const visibleCount = document.getElementById('visibleCount');
    if (visibleCount) {
        visibleCount.textContent = filteredData.length;
    }
}

function sortTable(sortKey) {
    const isNumeric = !isNaN(filteredData[0]?.[sortKey]);

    filteredData.sort((a, b) => {
        let aVal = a[sortKey];
        let bVal = b[sortKey];

        if (isNumeric) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        } else {
            aVal = String(aVal || '').toLowerCase();
            bVal = String(bVal || '').toLowerCase();
        }

        return aVal > bVal ? 1 : -1;
    });

    rebuildTable();
}

function rebuildTable() {
    const tbody = document.querySelector('#dataTable tbody');
    if (!tbody) return;

    // This is a simplified rebuild - in a real implementation,
    // you'd want to properly rebuild the rows with the template logic
    updateTable();
}

function clearFilters() {
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.reset();
        filteredData = [...originalData];
        updateTable();
        updateVisibleCount();
    }
}

function exportData() {
    const format = 'csv'; // Could be made configurable
    const headers = {{ (columns | map(attribute='label') | list) | tojson }};
    const keys = {{ (columns | map(attribute='key') | list) | tojson }};

    let csvContent = headers.join(',') + '\n';

    filteredData.forEach(row => {
        const values = keys.map(key => {
            let value = row[key] || '';
            // Escape quotes and wrap in quotes if contains comma
            value = String(value).replace(/"/g, '""');
            if (value.includes(',')) {
                value = `"${value}"`;
            }
            return value;
        });
        csvContent += values.join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `{{ title|replace(' ', '_')|lower }}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showAlert('Data exported successfully', 'success');
}

function refreshData() {
    window.location.reload();
}
</script>
{% endblock %}