{% extends "base.html" %}

{% block title %}View Configuration - {{ config.device_name }} - {{ app_name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('config.index') }}">Configurations</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('config.device_configs', device_name=config.device_name) }}">{{ config.device_name }}</a></li>
<li class="breadcrumb-item active">{{ config.config_type|title }} Config</li>
{% endblock %}

{% block content %}
<!-- Configuration Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0">
                            <i class="bi bi-file-text me-2"></i>
                            {{ config.device_name }} - {{ config.config_type|title }} Configuration
                        </h4>
                        <small class="text-muted">
                            Collected on {{ config.collection_time|datetime }}
                            ({{ config.collection_time|relative_time }})
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-secondary" onclick="downloadConfig()" title="Download configuration">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                            <button class="btn btn-outline-info" onclick="searchInConfig()" title="Search in configuration">
                                <i class="bi bi-search me-1"></i>Search
                            </button>
                            <button class="btn btn-outline-primary" onclick="copyToClipboard()" title="Copy to clipboard">
                                <i class="bi bi-clipboard me-1"></i>Copy
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" title="More actions">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark">
                                    <li><a class="dropdown-item" href="{{ url_for('config.device_configs', device_name=config.device_name) }}">
                                        <i class="bi bi-list me-2"></i>All Device Configs
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('devices.device_detail', device_name=config.device_name) }}">
                                        <i class="bi bi-router me-2"></i>Device Details
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="showConfigStats()">
                                        <i class="bi bi-graph-up me-2"></i>Config Statistics
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Configuration Type:</strong>
                        <span class="badge
                            {% if config.config_type == 'running' %}bg-success
                            {% elif config.config_type == 'startup' %}bg-warning
                            {% else %}bg-info{% endif %} ms-2">
                            {{ config.config_type|title }}
                        </span>
                    </div>
                    <div class="col-md-3">
                        <strong>Size:</strong> {{ config.size_bytes|file_size }}
                    </div>
                    <div class="col-md-3">
                        <strong>Lines:</strong> {{ config.line_count if config.line_count else 'N/A' }}
                    </div>
                    <div class="col-md-3">
                        <strong>Hash:</strong>
                        <code class="text-muted">{{ config.config_hash[:12] }}...</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Bar (Initially Hidden) -->
<div class="row mb-3 d-none" id="searchRow">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput"
                                   placeholder="Search in configuration..."
                                   onkeypress="handleSearchKeypress(event)">
                            <button class="btn btn-outline-primary" onclick="performSearch()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="searchOptions">
                            <option value="case-insensitive">Case Insensitive</option>
                            <option value="case-sensitive">Case Sensitive</option>
                            <option value="regex">Regular Expression</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span id="searchResults" class="text-muted me-3"></span>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="previousMatch()" disabled>
                                <i class="bi bi-chevron-up"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="nextMatch()" disabled>
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="clearSearch()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Content -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-code-square me-2"></i>
                    Configuration Content
                </h5>
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="lineNumbers" checked onchange="toggleLineNumbers()">
                        <label class="form-check-label" for="lineNumbers">Line Numbers</label>
                    </div>
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="wordWrap" onchange="toggleWordWrap()">
                        <label class="form-check-label" for="wordWrap">Word Wrap</label>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" onclick="increaseFontSize()" title="Increase font size">
                            <i class="bi bi-zoom-in"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="decreaseFontSize()" title="Decrease font size">
                            <i class="bi bi-zoom-out"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFontSize()" title="Reset font size">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="d-flex position-relative" style="height: 70vh;">
                    <!-- Line numbers column -->
                    <div id="lineNumbersColumn" class="bg-dark text-muted border-end" style="width: 70px; overflow: hidden; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.4; padding: 12px 8px; text-align: right; flex-shrink: 0;">
                        <div id="lineNumbersOverlay"></div>
                    </div>

                    <!-- Configuration content -->
                    <div class="flex-grow-1 position-relative">
                        <pre id="configContent" class="bg-black text-light m-0 p-3 rounded-0" style="height: 100%; overflow: auto; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.4;">{{ config.config_content }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Statistics Modal -->
<div class="modal fade" id="configStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Configuration Statistics</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card bg-secondary">
                            <div class="card-body text-center">
                                <h3 class="text-primary" id="totalLines">{{ config.line_count or 0 }}</h3>
                                <p class="mb-0">Total Lines</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-secondary">
                            <div class="card-body text-center">
                                <h3 class="text-info" id="totalChars">0</h3>
                                <p class="mb-0">Total Characters</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-secondary">
                            <div class="card-body text-center">
                                <h3 class="text-success" id="nonEmptyLines">0</h3>
                                <p class="mb-0">Non-Empty Lines</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-secondary">
                            <div class="card-body text-center">
                                <h3 class="text-warning" id="commentLines">0</h3>
                                <p class="mb-0">Comment Lines</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h6>Most Common Commands:</h6>
                    <div id="commonCommands" class="mt-2">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSearchTerm = '';
let searchMatches = [];
let currentMatchIndex = -1;
let fontSize = 0.875; // rem units

document.addEventListener('DOMContentLoaded', function() {
    generateLineNumbers();

    // Add syntax highlighting classes if available
    const configContent = document.getElementById('configContent');
    if (configContent) {
        // Basic syntax highlighting for common network config patterns
        highlightSyntax();
    }
});

function generateLineNumbers() {
    const content = document.getElementById('configContent');
    const overlay = document.getElementById('lineNumbersOverlay');

    if (!content || !overlay) return;

    const lines = content.textContent.split('\n');
    const lineNumbers = lines.map((_, index) =>
        `<div style="line-height: 1.4; height: 1.4em;">${index + 1}</div>`
    ).join('');

    overlay.innerHTML = lineNumbers;
}

function toggleLineNumbers() {
    const column = document.getElementById('lineNumbersColumn');
    const isChecked = document.getElementById('lineNumbers').checked;

    if (isChecked) {
        column.style.display = 'block';
    } else {
        column.style.display = 'none';
    }
}

function toggleWordWrap() {
    const content = document.getElementById('configContent');
    const isChecked = document.getElementById('wordWrap').checked;

    content.style.whiteSpace = isChecked ? 'pre-wrap' : 'pre';
    content.style.wordBreak = isChecked ? 'break-all' : 'normal';
}

function increaseFontSize() {
    fontSize = Math.min(fontSize + 0.125, 1.5);
    updateFontSize();
}

function decreaseFontSize() {
    fontSize = Math.max(fontSize - 0.125, 0.5);
    updateFontSize();
}

function resetFontSize() {
    fontSize = 0.875;
    updateFontSize();
}

function updateFontSize() {
    const content = document.getElementById('configContent');
    const column = document.getElementById('lineNumbersColumn');

    content.style.fontSize = fontSize + 'rem';
    column.style.fontSize = fontSize + 'rem';

    // Regenerate line numbers to match new font size
    setTimeout(generateLineNumbers, 100);
}

function searchInConfig() {
    const searchRow = document.getElementById('searchRow');
    const searchInput = document.getElementById('searchInput');

    if (searchRow.classList.contains('d-none')) {
        searchRow.classList.remove('d-none');
        searchInput.focus();
    } else {
        searchRow.classList.add('d-none');
        clearSearch();
    }
}

function handleSearchKeypress(event) {
    if (event.key === 'Enter') {
        performSearch();
    }
}

function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    const searchOption = document.getElementById('searchOptions').value;
    const content = document.getElementById('configContent');

    if (!searchTerm) {
        clearSearch();
        return;
    }

    currentSearchTerm = searchTerm;

    // Clear previous highlights
    clearHighlights();

    // Get original text
    const originalText = `{{ config.config_content|safe }}`;

    let regex;
    if (searchOption === 'regex') {
        try {
            regex = new RegExp(searchTerm, 'g');
        } catch (e) {
            showAlert('Invalid regular expression: ' + e.message, 'danger');
            return;
        }
    } else {
        const flags = searchOption === 'case-sensitive' ? 'g' : 'gi';
        regex = new RegExp(escapeRegex(searchTerm), flags);
    }

    // Find matches
    searchMatches = [];
    let match;
    while ((match = regex.exec(originalText)) !== null) {
        searchMatches.push({
            index: match.index,
            text: match[0]
        });
        // Prevent infinite loop on zero-length matches
        if (match.index === regex.lastIndex) {
            regex.lastIndex++;
        }
    }

    if (searchMatches.length === 0) {
        document.getElementById('searchResults').textContent = 'No matches found';
        updateNavigationButtons();
        return;
    }

    // Highlight matches
    let highlightedText = originalText;
    let offset = 0;

    searchMatches.forEach((match, index) => {
        const startTag = `<mark class="search-highlight" data-match="${index}">`;
        const endTag = '</mark>';
        const adjustedIndex = match.index + offset;

        highlightedText =
            highlightedText.slice(0, adjustedIndex) +
            startTag +
            highlightedText.slice(adjustedIndex, adjustedIndex + match.text.length) +
            endTag +
            highlightedText.slice(adjustedIndex + match.text.length);

        offset += startTag.length + endTag.length;
    });

    content.innerHTML = highlightedText;

    // Update results and navigation
    document.getElementById('searchResults').textContent = `${searchMatches.length} matches`;
    currentMatchIndex = 0;
    updateNavigationButtons();
    highlightCurrentMatch();
    scrollToCurrentMatch();
}

function clearSearch() {
    const content = document.getElementById('configContent');
    content.innerHTML = `{{ config.config_content|safe }}`;

    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').textContent = '';

    searchMatches = [];
    currentMatchIndex = -1;
    updateNavigationButtons();

    // Regenerate line numbers
    setTimeout(generateLineNumbers, 100);
}

function clearHighlights() {
    const highlights = document.querySelectorAll('.search-highlight');
    highlights.forEach(highlight => {
        highlight.classList.remove('current-match');
    });
}

function previousMatch() {
    if (searchMatches.length === 0) return;

    currentMatchIndex = currentMatchIndex <= 0 ? searchMatches.length - 1 : currentMatchIndex - 1;
    highlightCurrentMatch();
    scrollToCurrentMatch();
}

function nextMatch() {
    if (searchMatches.length === 0) return;

    currentMatchIndex = currentMatchIndex >= searchMatches.length - 1 ? 0 : currentMatchIndex + 1;
    highlightCurrentMatch();
    scrollToCurrentMatch();
}

function highlightCurrentMatch() {
    clearHighlights();

    if (currentMatchIndex >= 0 && currentMatchIndex < searchMatches.length) {
        const currentHighlight = document.querySelector(`[data-match="${currentMatchIndex}"]`);
        if (currentHighlight) {
            currentHighlight.classList.add('current-match');
        }

        document.getElementById('searchResults').textContent =
            `${currentMatchIndex + 1} of ${searchMatches.length} matches`;
    }
}

function scrollToCurrentMatch() {
    const currentHighlight = document.querySelector(`[data-match="${currentMatchIndex}"]`);
    if (currentHighlight) {
        currentHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function updateNavigationButtons() {
    const hasMatches = searchMatches.length > 0;
    document.querySelector('button[onclick="previousMatch()"]').disabled = !hasMatches;
    document.querySelector('button[onclick="nextMatch()"]').disabled = !hasMatches;
}

function downloadConfig() {
    const configContent = `{{ config.config_content|safe }}`;
    const blob = new Blob([configContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');

    a.href = url;
    a.download = `{{ config.device_name }}_{{ config.config_type }}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showAlert('Configuration downloaded successfully', 'success');
}

function copyToClipboard() {
    const configContent = `{{ config.config_content|safe }}`;

    if (navigator.clipboard) {
        navigator.clipboard.writeText(configContent).then(() => {
            showAlert('Configuration copied to clipboard', 'success');
        }).catch(err => {
            fallbackCopyToClipboard(configContent);
        });
    } else {
        fallbackCopyToClipboard(configContent);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        showAlert('Configuration copied to clipboard', 'success');
    } catch (err) {
        showAlert('Failed to copy to clipboard', 'danger');
    }

    document.body.removeChild(textArea);
}

function showConfigStats() {
    const modal = new bootstrap.Modal(document.getElementById('configStatsModal'));
    modal.show();

    // Calculate statistics
    const configContent = `{{ config.config_content|safe }}`;
    const lines = configContent.split('\n');

    const stats = {
        totalLines: lines.length,
        totalChars: configContent.length,
        nonEmptyLines: lines.filter(line => line.trim().length > 0).length,
        commentLines: lines.filter(line => line.trim().startsWith('#') || line.trim().startsWith('!')).length
    };

    // Update stats display
    document.getElementById('totalLines').textContent = stats.totalLines.toLocaleString();
    document.getElementById('totalChars').textContent = stats.totalChars.toLocaleString();
    document.getElementById('nonEmptyLines').textContent = stats.nonEmptyLines.toLocaleString();
    document.getElementById('commentLines').textContent = stats.commentLines.toLocaleString();

    // Analyze common commands
    analyzeCommonCommands(lines);
}

function analyzeCommonCommands(lines) {
    const commands = {};
    const commonCommands = document.getElementById('commonCommands');

    lines.forEach(line => {
        const trimmed = line.trim();
        if (trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('!')) {
            // Extract first word (command)
            const firstWord = trimmed.split(/\s+/)[0];
            if (firstWord.length > 1) {
                commands[firstWord] = (commands[firstWord] || 0) + 1;
            }
        }
    });

    // Sort by frequency and take top 10
    const sortedCommands = Object.entries(commands)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);

    if (sortedCommands.length === 0) {
        commonCommands.innerHTML = '<p class="text-muted">No commands found</p>';
        return;
    }

    const commandsHtml = sortedCommands.map(([command, count]) =>
        `<div class="d-flex justify-content-between align-items-center mb-1">
            <span><code>${command}</code></span>
            <span class="badge bg-primary">${count}</span>
        </div>`
    ).join('');

    commonCommands.innerHTML = commandsHtml;
}

function highlightSyntax() {
    // Basic syntax highlighting for network configurations
    const content = document.getElementById('configContent');
    if (!content) return;

    // This is a simplified syntax highlighter
    // In a production environment, you might want to use a proper syntax highlighting library
    // like Prism.js or highlight.js
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Initialize line numbers toggle
document.addEventListener('DOMContentLoaded', function() {
    toggleLineNumbers(); // Set initial state
});
</script>

<style>
.search-highlight {
    background-color: #ffc107;
    color: #000;
    padding: 0 2px;
    border-radius: 2px;
}

.search-highlight.current-match {
    background-color: #fd7e14;
    color: #fff;
    font-weight: bold;
}

#lineNumbersColumn {
    user-select: none;
    border-right: 1px solid #495057;
    background-color: #343a40 !important;
}

#configContent {
    counter-reset: line;
}

.config-line {
    counter-increment: line;
}

.config-line::before {
    content: counter(line);
    display: inline-block;
    width: 3em;
    padding-right: 0.5em;
    margin-right: 0.5em;
    text-align: right;
    color: #6c757d;
    border-right: 1px solid #495057;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #configContent {
        font-size: 0.75rem;
    }

    .card-header .btn-group {
        flex-direction: column;
    }

    .card-header .form-check {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}